#user nobody;
worker_processes  4;
 
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
 
#pid        logs/nginx.pid;
 
events {
    use   epoll; 
 
    worker_connections  1024;
 
}
 
 
http {
    server_tokens off;
    include    mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
 
    #access_log  logs/access.log  main;
 
    sendfile     on;
    #tcp_nopush     on;
 
    #keepalive_timeout  0;
    keepalive_timeout  65;
    tcp_nodelay     on;
 
    gzip  on;
    gzip_disable "MSIE [1-6].";
    fastcgi_connect_timeout 500;
    fastcgi_send_timeout 500;
    fastcgi_read_timeout 500;

    client_header_timeout 500s;        
    client_body_timeout 500s;          
    client_max_body_size 300000m;  
    client_header_buffer_size    256k;
    large_client_header_buffers  4 256k;

    map $http_upgrade $connection_upgrade {
      default upgrade;
      ''      close;
    }
    upstream websocketalarm {
        server 172.16.32.33:8811; 
    }
    upstream websocketdevice {
        server 172.16.32.33:8807;
    }
    upstream websocketcommon {
        server 172.16.32.33:8808;
    }
	upstream websocketvade {
        server 172.16.33.130:8715;
    }
    
    server {
        listen    80;
        server_name ummi.web.local;
		#proxy_buffer_size   128k;
		#proxy_buffers   4 256k;
		#proxy_busy_buffers_size   256k; 
		root /usr/share/nginx/html;
		index index.html index.htm;
        #access_log  logs/nginx.access.log  main;
 
        location / {
	    try_files $uri /index.html;
            #root /usr/share/nginx/html;
            #index index.html index.htm;
        }
	
		location /api {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_pass http://ummi.local:8801/;
			proxy_read_timeout 600s;
		}

		location /socketalarm {
			proxy_pass http://websocketalarm/;
			
			proxy_read_timeout 600s;
				proxy_http_version 1.1;
				proxy_set_header Upgrade $http_upgrade;
				proxy_set_header Connection $connection_upgrade;
		}

		location /socketdevice {
			proxy_pass http://websocketdevice/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}	

		location /socketcommon {
			proxy_pass http://websocketcommon/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
		location /vadeWebSocketApi {
			proxy_pass http://websocketvade/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}	
 
        error_page   500 502 503 504 /50x.html;
			location = /50x.html {
        }
 
        location ~ ^/(images|javascript|js|css|flash|media|static|json|html)/ {
            root /usr/share/nginx/html;
			#proxy_cache_valid any 0s;
            expires -1;
        }
		error_page  405     =200 $uri;
    }
	
	server {
        listen       443 ssl;
        server_name  ummi.web.local;
        #ssl on;
        ssl_session_timeout 5m;        
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;         
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_certificate  /ummi-nginx.crt;
        ssl_certificate_key /ummi-nginx.key;
		
		root /usr/share/nginx/html;
		index index.html index.htm;
		
		location / {
			try_files $uri /index.html;
            #root /usr/share/nginx/html;
            #index index.html index.htm;
        }
		
		location /api {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_pass http://172.16.32.33:8801/;
			proxy_read_timeout 600s;
		}
		
		#location /api {
		#	proxy_set_header X-Real-IP $remote_addr;
		#	proxy_pass http://ummi.web.local:80/api;
		#	proxy_read_timeout 600s;
		#}
		
		location ~ ^/(images|javascript|js|css|flash|media|static|json|html)/ {
			root /usr/share/nginx/html;
			expires -1;
		}
		
		location /adfs {
            proxy_pass https://ummi.local:8802;
        }
		
		location /socketalarm {
			proxy_pass http://websocketalarm/;
			
			proxy_read_timeout 600s;
				proxy_http_version 1.1;
				proxy_set_header Upgrade $http_upgrade;
				proxy_set_header Connection $connection_upgrade;
		}

		location /socketdevice {
			proxy_pass http://websocketdevice/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}	

		location /socketcommon {
			proxy_pass http://websocketcommon/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
		
		location /vadeWebSocketApi {
			proxy_pass http://websocketvade/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
    }
}
