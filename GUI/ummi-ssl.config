#user nobody;
worker_processes  4;
 
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
 
#pid        logs/nginx.pid;
 
events {
    use   epoll; 
 
    worker_connections  1024;
 
}
 
 
http {
    include    mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
 
    #access_log  logs/access.log  main;
 
    sendfile     on;
    #tcp_nopush     on;
 
    #keepalive_timeout  0;
    keepalive_timeout  65;
    tcp_nodelay     on;
 
    gzip  on;
    gzip_disable "MSIE [1-6].";
    fastcgi_connect_timeout 500;
    fastcgi_send_timeout 500;
    fastcgi_read_timeout 500;

    client_header_timeout 500s;        
    client_body_timeout 500s;          
    client_max_body_size 300000m;  
    client_header_buffer_size    256k;
    large_client_header_buffers  4 256k;

    map $http_upgrade $connection_upgrade {
      default upgrade;
      ''      close;
    }   
    upstream websocketcommon {
        server 172.16.32.33:8808;
    }
	upstream websocketvade {
        server 10.10.0.132:8715;
    }

    upstream arcgislibrary {
        server 172.16.32.33:443
    }
	
	server {
        listen       8443 ssl;
        server_name  ummi.web.local;
        #ssl on;
        ssl_session_timeout 5m;        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
		ssl_certificate  /ummi-nginx.crt;
        ssl_certificate_key /ummi-nginx.key;

        if ($arg_username){
            return 405;
        }
        if ($arg_password){
            return 405;
        }
        if ($request_method !~ ^(PUT|DELETE|GET|POST)$ ) {
            return 405;
        }
        # ~* 'PUT|DELETE|GET|POST|HEAD|CONNECT|OPTIONS|TRACE|PATCH'
        if ($arg__method){
            return 405;
        }
        if ($http_X_HTTP_Method_Override) {
            return 405;
        }
        if ($http_X_HTTP_METHOD) {
            return 405;
        }
        if ($http_X_METHOD_OVERRIDE) {
            return 405;
        }
		
		root /usr/share/nginx/html;
		index index.html index.htm;
		
		location / {
			try_files $uri /index.html;
            #root /usr/share/nginx/html;
            #index index.html index.htm;
        }
		
		location /api {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_pass https://172.16.38.123:32100/;
			proxy_read_timeout 600s;
		}

        location /library/js/4.11 {
			proxy_pass https://arcgislibrary/library/js/4.11;
		}
		
		location /library/css/4.11 {
			proxy_pass https://arcgislibrary/library/css/4.11;
		}
		
		location /library {
			proxy_pass https://arcgislibrary/library;
		}

		location /vms/fts/v1 {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_pass http://172.16.33.203:80/vms/fts/v1;
			proxy_read_timeout 600s;
		}

		location /downloadApi/control/files {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://websocketvade/control/files;
            proxy_read_timeout 600s;
        }

		location ~ ^/(images|javascript|js|css|flash|media|static|json|html)/ {
			root /usr/share/nginx/html;
			expires -1;
		}
		
		location /socketcommon {
			proxy_pass http://websocketcommon/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
		
		location /vadeWebSocketApi {
			proxy_pass http://websocketvade/;
			
			proxy_read_timeout 600s;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
		}
    }
}
